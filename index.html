<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cybersecurity Regulations Filter</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .filter-container {
            margin-bottom: 20px;
        }
        .filter-container label {
            margin-right: 10px;
        }
        .filter-container select {
            padding: 5px;
            margin-right: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .loading, .error {
            color: #ff0000;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>Cybersecurity Regulations Filter</h1>
    <div class="filter-container">
        <label for="jurisdiction">Jurisdiction:</label>
        <select id="jurisdiction">
            <option value="">All</option>
            <option value="Single-Jurisdiction">Single-Jurisdiction</option>
            <option value="Multi-Jurisdiction">Multi-Jurisdiction</option>
            <option value="European Union">European Union</option>
        </select>

        <label for="country">Country/Org:</label>
        <select id="country">
            <option value="">All</option>
        </select>

        <label for="institution">Institution:</label>
        <select id="institution">
            <option value="">All</option>
        </select>
    </div>

    <div id="loading" class="loading">Loading regulations...</div>
    <div id="error" class="error" style="display: none;"></div>
    <table id="regulations-table" style="display: none;">
        <thead>
            <tr>
                <th>Edition</th>
                <th>Doc ID</th>
                <th>Application</th>
                <th>Country/Org</th>
                <th>Institution</th>
                <th>Date</th>
                <th>Document</th>
            </tr>
        </thead>
        <tbody id="regulations-body"></tbody>
    </table>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // Replace 'your-username' with your GitHub username
        const excelUrl = 'https://raw.githubusercontent.com/CybersecFox/CyberRegulations/main/data/CyberDigest-Indexes-v6-FINAL%20(4).xlsx';
        const targetSheet = 'DIGEST Document Links v6';

        let globalData = [];

        async function loadExcelData() {
            try {
                console.log('Fetching Excel file from:', excelUrl);
                const response = await fetch(excelUrl);
                if (!response.ok) throw new Error(`Failed to fetch Excel file: ${response.status} ${response.statusText}`);
                const arrayBuffer = await response.arrayBuffer();
                const workbook = XLSX.read(new Uint8Array(arrayBuffer), { type: 'array' });

                // Log all sheet names
                console.log('Available sheets:', workbook.SheetNames);

                // Check if target sheet exists
                if (!workbook.SheetNames.includes(targetSheet)) {
                    throw new Error(`Sheet "${targetSheet}" not found. Available sheets: ${workbook.SheetNames.join(', ')}`);
                }

                const sheet = workbook.Sheets[targetSheet];
                const data = XLSX.utils.sheet_to_json(sheet, { header: 1 });

                // Log column headers
                const headers = data[0] || [];
                console.log('Column headers in DIGEST Document Links v6:', headers);

                // Verify COUNTRY/ORG header
                if (!headers.includes('COUNTRY/ORG')) {
                    throw new Error(`COUNTRY/ORG column not found in sheet "${targetSheet}". Headers: ${headers.join(', ')}`);
                }

                // Convert to object array
                const formattedData = data.slice(1).map(row => {
                    const obj = {};
                    headers.forEach((header, index) => {
                        obj[header] = row[index];
                    });
                    return obj;
                }).filter(row => row['COUNTRY/ORG']); // Remove rows with empty COUNTRY/ORG

                console.log('Excel data loaded:', formattedData.length, 'rows');
                console.log('COUNTRY/ORG values:', [...new Set(formattedData.map(row => row['COUNTRY/ORG']))].sort());

                if (!formattedData.length) throw new Error('No valid data rows with COUNTRY/ORG in sheet');

                globalData = formattedData;
                document.getElementById('loading').style.display = 'none';
                populateDropdowns(globalData);
                displayRegulations(globalData);
            } catch (error) {
                console.error('Error loading Excel:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').textContent = `Error: ${error.message}. Check console for details.`;
            }
        }

        function populateDropdowns(data) {
            const countries = [...new Set(data.map(row => row['COUNTRY/ORG']).filter(val => val))].sort();
            const institutions = [...new Set(data.map(row => row['INSTITUTION']).filter(val => val))].sort();

            const countrySelect = document.getElementById('country');
            countrySelect.innerHTML = '<option value="">All</option>';
            countries.forEach(country => {
                const option = document.createElement('option');
                option.value = country;
                option.textContent = country;
                countrySelect.appendChild(option);
            });

            if (countries.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'No countries available';
                countrySelect.appendChild(option);
            }

            const institutionSelect = document.getElementById('institution');
            institutionSelect.innerHTML = '<option value="">All</option>';
            institutions.forEach(institution => {
                const option = document.createElement('option');
                option.value = institution;
                option.textContent = institution;
                institutionSelect.appendChild(option);
            });

            if (institutions.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'No institutions available';
                institutionSelect.appendChild(option);
            }

            console.log('Country/Org dropdown populated with:', countries);
        }

        function displayRegulations(data) {
            const jurisdiction = document.getElementById('jurisdiction').value;
            const country = document.getElementById('country').value;
            const institution = document.getElementById('institution').value;

            console.log('Filtering with:', { jurisdiction, country, institution });

            const filteredData = data.filter(row => {
                return (!jurisdiction || row['APPLICATION'] === jurisdiction) &&
                       (!country || row['COUNTRY/ORG'] === country) &&
                       (!institution || row['INSTITUTION'] === institution);
            });

            const tbody = document.getElementById('regulations-body');
            tbody.innerHTML = '';

            filteredData.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row['Edition'] || ''}</td>
                    <td>${row['DOC # (INDEX)'] || ''}</td>
                    <td>${
